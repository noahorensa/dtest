name: C/C++ CI

on: [ push, pull_request ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Build
      run: |
        make dtest dtest-cxx11 dtest-cxx14 dtest-cxx17 build-tests
        mkdir static
        make dtest-static STATIC_TARGET=static/dtest-static "STATIC_TESTS=$(find test/build/*/static/*.dtest.o -printf '%p ')" EXTRACXXFLAGS=-fopenmp

    - name: Run tests (default)
      continue-on-error: true
      run: ./dtest test/build
    - name: Dump results (default)
      continue-on-error: true
      run: cat dtest.log.json

    - name: Run tests (default-static)
      continue-on-error: true
      run: cd static && ./dtest-static
    - name: Dump results (default-static)
      continue-on-error: true
      run: cat static/dtest.log.json

    - name: Run tests (c++11)
      continue-on-error: true
      run: ./dtest-cxx11 test/build
    - name: Dump results (c++11)
      continue-on-error: true
      run: cat dtest.log.json

    - name: Run tests (c++14)
      continue-on-error: true
      run: ./dtest-cxx14 test/build
    - name: Dump results (c++14)
      continue-on-error: true
      run: cat dtest.log.json

    - name: Run tests (c++17)
      continue-on-error: true
      run: ./dtest-cxx17 test/build
    - name: Dump results (c++17)
      continue-on-error: true
      run: cat dtest.log.json
